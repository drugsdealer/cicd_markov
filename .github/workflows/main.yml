name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          echo "🛠 Building Docker image..."
          docker build -t drugsdealer/cicd_markov:${{ github.run_number }} .

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: "drugsdealer"       # твой DockerHub username
          password: "${{ secrets.DOCKERHUB_TOKEN }}"

      - name: Push Docker image
        run: |
          echo "📦 Pushing Docker image..."
          docker push drugsdealer/cicd_markov:${{ github.run_number }}

      - name: Notify Telegram (direct test)
        uses: appleboy/telegram-action@master
        with:
          to: "1118452731"
          token: "8218668682:AAH3sp-Bd-485oEXdkUPTm0PqxaeOK11MD8"
          message: |
            ✅ CI/CD пайплайн отработал успешно!
            🚀 Репозиторий: ${{ github.repository }}
            🧱 Коммит: ${{ github.event.head_commit.message }}
            🔗 DockerHub: https://hub.docker.com/repository/docker/drugsdealer/cicd_markov
            🕒 Версия: v${{ github.run_number }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ✅ CI/CD прошёл успешно
            🐳 Docker образ опубликован
            📬 Уведомление отправлено в Telegram
