name: Stage Store CI/CD Full

on:
  push:
    branches:
      - main
      - 'feature/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  # 1) Ð¢ÐµÑÑ‚Ñ‹
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install deps (optional)
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, skipping"
          fi

      - name: Dummy tests
        run: echo "Tests passed"

      - name: "Add PR label test-passed"
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: test-passed

  # 2) Security (Ð½Ðµ Ð¿Ð°Ð´Ð°ÐµÐ¼, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ)
  security:
    name: Security Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install safety & flake8
        run: |
          python -m pip install --upgrade pip
          pip install safety flake8 || true

      - name: Safety scan
        run: safety check || true

      - name: Lint (flake8)
        run: flake8 . || true

      - name: "Add PR label sec-passed"
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: sec-passed

  # 3) Ð’ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (minor Ð´Ð»Ñ feature/*, Ð¸Ð½Ð°Ñ‡Ðµ patch)
  version:
    name: Update Version
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Read current version
        id: readver
        run: |
          if [ -f version ]; then
            CURR=$(cat version)
          else
            CURR="0.1.0"
            echo "$CURR" > version
          fi
          echo "current_version=$CURR" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        run: |
          OLD=${{ steps.readver.outputs.current_version }}
          IFS='.' read -r MAJ MIN PATCH <<< "$OLD"
          # feature/* -> minor++, Ð¸Ð½Ð°Ñ‡Ðµ patch++
          if [[ "${GITHUB_REF}" == refs/heads/feature/* ]]; then
            MIN=$((MIN + 1))
          else
            PATCH=$((PATCH + 1))
          fi
          NEW="$MAJ.$MIN.$PATCH"
          echo "$NEW" > version
          echo "new_version=$NEW" >> $GITHUB_OUTPUT
          echo "Updated: $OLD -> $NEW"

      - name: Commit version file
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add version
          git commit -m "version: ${{ steps.bump.outputs.new_version }} <- ${{ steps.readver.outputs.current_version }}" || true
          git push || true

      - name: "Add PR label version-updated"
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: version-updated

  # 4) Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÑƒÑˆ Ð² main)
  notify:
    name: Notify Telegram
    runs-on: ubuntu-latest
    needs: version
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Send Telegram message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            âœ… Ð’Ñ‹Ð¿ÑƒÑ‰ÐµÐ½Ð° Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ
            ðŸ“¦ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}
            ðŸ”€ Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}
            ðŸ§¾ Ð’ÐµÑ€ÑÐ¸Ñ: ${{ needs.version.outputs.new_version || 'see version file' }}
            ðŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
