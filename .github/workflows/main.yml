name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          echo "ğŸ›  Building Docker image..."
          docker build -t drugsdealer/cicd_markov:${{ github.run_number }} .

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: "drugsdealer"       # Ñ‚Ğ²Ğ¾Ğ¹ DockerHub username
          password: "${{ secrets.DOCKERHUB_TOKEN }}"

      - name: Push Docker image
        run: |
          echo "ğŸ“¦ Pushing Docker image..."
          docker push drugsdealer/cicd_markov:${{ github.run_number }}

      - name: Notify Telegram (direct test)
        uses: appleboy/telegram-action@master
        with:
          to: "1118452731"
          token: "8218668682:AAH3sp-Bd-485oEXdkUPTm0PqxaeOK11MD8"
          message: |
            âœ… CI/CD Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ Ğ¾Ñ‚Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!
            ğŸš€ Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹: ${{ github.repository }}
            ğŸ§± ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}
            ğŸ”— DockerHub: https://hub.docker.com/repository/docker/drugsdealer/cicd_markov
            ğŸ•’ Ğ’ĞµÑ€ÑĞ¸Ñ: v${{ github.run_number }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            âœ… CI/CD Ğ¿Ñ€Ğ¾ÑˆÑ‘Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
            ğŸ³ Docker Ğ¾Ğ±Ñ€Ğ°Ğ· Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½
            ğŸ“¬ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² Telegram
