name: Stage Store CI/CD Full

on:
  push:
    branches: [ main, feature/*, hotfix/* ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  # 1ï¸âƒ£ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          echo "ğŸ”§ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..."
          pip install -r requirements.txt || echo "requirements.txt Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼"

      - name: Run dummy tests
        run: |
          echo "âœ… Ğ¢ĞµÑÑ‚Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹!"
          echo "test passed"

      - name: Add PR label: test-passed
        if: github.event_name == 'pull_request'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: test-passed

  # 2ï¸âƒ£ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  security:
    name: Security Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      - name: Run Safety (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹)
        run: |
          echo "ğŸ›¡ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ° ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..."
          pip install safety || echo "safety Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
          safety check || echo "âš ï¸ Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ (Ğ´ĞµĞ¼Ğ¾-Ñ€ĞµĞ¶Ğ¸Ğ¼)"

      - name: Run Linter (Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ğ´Ğ°)
        run: |
          pip install flake8 || echo "flake8 Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
          echo "ğŸ§¹ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€..."
          flake8 . || echo "âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ»Ğ¸Ğ½Ñ‚Ğ¸Ğ½Ğ³Ğ° (Ğ´ĞµĞ¼Ğ¾-Ñ€ĞµĞ¶Ğ¸Ğ¼)"

      - name: Add PR label: sec-passed
        if: github.event_name == 'pull_request'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: sec-passed

  # 3ï¸âƒ£ ĞĞ¿Ğ´ĞµĞ¹Ñ‚ Ğ²ĞµÑ€ÑĞ¸Ğ¸
  version:
    name: Update Version
    runs-on: ubuntu-latest
    needs: security
    steps:
      - uses: actions/checkout@v3

      - name: Read current version
        id: version
        run: |
          echo "ğŸ“– Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ..."
          if [ -f version ]; then
            cat version
            echo "current_version=$(cat version)" >> $GITHUB_OUTPUT
          else
            echo "0.1.0" > version
            echo "current_version=0.1.0" >> $GITHUB_OUTPUT
          fi

      - name: Calculate new version
        id: bump
        run: |
          echo "ğŸ§® Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ..."
          old=${{ steps.version.outputs.current_version }}
          major=$(echo $old | cut -d. -f1)
          minor=$(echo $old | cut -d. -f2)
          patch=$(echo $old | cut -d. -f3)
          if [[ "${{ github.ref }}" == *"feature"* ]]; then
            minor=$((minor + 1))
          else
            patch=$((patch + 1))
          fi
          new="$major.$minor.$patch"
          echo "new_version=$new" >> $GITHUB_OUTPUT
          echo $new > version
          echo "ğŸ”– ĞĞ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ: $new"

      - name: Commit new version
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add version
          git commit -m "ğŸ”¼ Version bump: ${{ steps.bump.outputs.new_version }} <- ${{ steps.version.outputs.current_version }}"
          git push

      - name: Add PR label: version-updated
        if: github.event_name == 'pull_request'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: version-updated
